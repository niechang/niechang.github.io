{"text":"Redis服务器是一个事件驱动程序，包括以下两类事件：\n\n- 文件事件(file event)：Redis服务器通过套接字与客户端进行连接，而文件事件就是服务器对套接字操作的抽象。\n- 事件事件(time event)：Redis服务器中的一些操作(如serverCron函数)需要在给定的时间点执行，而时间事件就是服务器对这类定时操作的抽象。\n\n###文件事件\nRedis基于Reactor模式开发了自己的网络事件处理器即文件事件处理器(file event handler)：\n\n- 文件事件处理器使用I/O多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的时间处理器\n- 当被监听的套接字准备好执行连接应答、读取、写入、关闭等操作时，域操作相关的文件事件就会产生，这时文件处理器就会被套接字之前关联好的事件处理器来处理这些事件\n\n文件处理器的构成\n\n- 套接字：文件事件对套接字进行抽象\n- I/O多路复用程序：负责监听多个套接字，并向文件事件分派器传送那些产生事件的套接字\n- 文件事件分派器：接收I/O多路复用程序传来的套接字，并根据套接字产生的事件的类型调用相应的事件处理器\n- 事件处理器：定义事件发生时服务器执行的动作\n\nRedis的IO多路复用程序的所有功能都是通过包装常见的select、epoll、evport、和kqueue这些IO多路复用函数来实现的，每个IO多路复用函数库在Redis中都对应一个单独的文件。\n\n**文件事件的类型**\nIO多路复用器可以监听多个套接字的ae.h/AE_READABLE事件和ae.h/AE_WRITABLE事件：\n\n- 当套接字变得可读时(客户端对套接字进行write或close)或有新的可应答套接字出现时(客户端执行connect)，套接字产生AE_READABLE事件\n- 当套接字变得可写时(客户端对套接字执行read操作)，套接字产生AE_WRITABLE事件\n\nIO多路复用器允许同时监听套接字的AE_READABLE事件和AE_WRITABLE事件，如果同时产生这两种事件，文件事件分发器会优先执行AE_READABLE。\n\n**文件事件的处理器**\n\n- 连接应答处理器：`networking.c/acceptTcpHandler`函数是Redis连接应答处理器，这个处理器用于对连接服务器监听套接字的客户端进行应答，具体实现为`sys/sockect.h/accept`函数的包装\n- 命令请求处理器：`networking.c/readQueryFromClient`函数是Redis命令请求处理器，负责从套接字中读入客户端发送的命令请求内容，具体实现为`unistd.h/read`函数的包装\n- 命令回复处理器：`networking.c/sendReplyToClient`函数是以Redis的命令回复处理器，负责将服务器执行命令后得到的命令回复通过套接字返回给客户端，具体实现为`unistd.h/write`函数包装\n\n###时间事件\nRedis时间事件分为两类：\n\n- 定时事件：让一段程序在指定的时间之后执行\n- 周期性事件：让一段程序每隔指定时间就执行\n\n一个时间事件由以下三个属性组成：\n\n- id：服务器为时间事件创建的全局唯一ID，从小到大的顺序递增\n- when：毫秒精度的UNIX时间戳，记录时间到达 时间\n- timeProc：时间事件处理器\n\n一个时间事件是定时事件还是周期性事件取决于时间事件处理器的返回值：\n\n- 如果事件处理器返回`ae.h/AE_NOMORE`，那么这个事件为定时事件，该事件在到达一次之后将会被删除\n- 如果事件处理器返回非AE_NOMORE整数值，那么这个事件为周期性事件；当事件在到达一次之后，服务器会根据事件处理器的返回值，对时间事件的when进行更新，让这个事件在一段时间之后再次到达\n\n**实现**\n\n服务器将所有的时间事件都保存放在一个无序链表中(无序是指没有按照when排序而是按照id排序新加入事件在头部)，每当事件执行器运行时，它就会遍历整个链表，查找所有已到达的时间事件，并调用相应的事件处理器\n\n**实例**\n\n持续运行的Redis服务器需要定期对自身的资源和状态进行检查和调整，从而确保服务器可以长期、稳定的执行，这些定期操作由`redis.c/serverCron`函数执行，其主要工作包括：\n\n- 更新服务器的各类统计信息，比如时间、内存占用、数据库占用\n- 清理数据库中的过期键值对\n- 关闭和清理连接失效的客户端\n- 尝试进行AOF或RDB持久化操作\n- 如果服务器是主服务器，那么对从服务器进行定期同步\n- 如果处于集群模式，对集群进行定期同步和连接测试\n\nRedis以周期性事件的方式运行`serverCron`函数，2.6版本默认规定秒运行10次该函数。服务器一般情况下执行`serverCron`函数一个时间事件。\n\n"}