<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Post Management</title>
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="css/blog.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/editor.css" />
    <link href="css/prettify.css" type="text/css" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="http://cdn.bootcss.com/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="blog-masthead">
      <div class="container">
        <nav class="blog-nav">
          <a class="blog-nav-item" href="index.html">Home</a>
          <a class="blog-nav-item active" href="manage.html">Manage</a>
        </nav>
      </div>
    </div>

    <div class="container blog-admin">
      <div class="blog-header"></div>

      <div class="row">
        <table class="table table-hover"  id="blogs_list"> <!-- list blogs-->
          <thead>
            <tr><td colspan="4" class="text-right"><a href="#" id="add_post"><strong>发布文章</strong></a></td></tr>
          </thead>
          <tbody>
          </tbody>
        </table><!-- blog list -->
      </div>

      <div class="row">
        <div id="login_form"> 
            <div class="form-group text-center">
             <button type="submit" class="btn btn-primary btn-lg" id="login_btn">Login in with GitHub </button>
            </div>
        </div> <!-- login form -->
      </div>  


      <div class="row">
        <form role="form" method="post" id="blog_form" style="display:none"> <!-- add blog form-->
          <div class="col-sm-4">
            <input name="title" type="text" placeholder="Title?" class="form-control" />
            <input name="id" type="hidden" id="post_id"/>
            <input name="tags" type="hidden" id="create_time"/>
          </div>
          <div class="col-sm-6" id="blog_tags">    
          </div>
          <div class="col-sm-2" id="blog_tags">  
              <button type="button" class="btn btn-sm btn-primary" id="return_btn">Return</button>
              <button type="submit" class="btn  btn-sm btn-primary" id="post_save">Save</button>
          </div>
        </form> 
      </div>  
      <div class="row" style="display:none" id="blog_editor">
          <div class="col-sm-6">
              <div class="wmd-panel">
                  <div id="wmd-button-bar"></div>
                  <textarea class="wmd-input" id="wmd-input" name="content"></textarea>
              </div>
          </div>
          <div class="col-sm-6">
              <div id="wmd-preview" class="wmd-panel wmd-preview"></div>
          </div>
      </div>

    </div><!-- /.container -->


    <div class="blog-footer">
      <p>Blog built with <a href="http://getbootstrap.com">Bootstrap</a> by <a href="github.com/niechang">@Chad</a>.</p>
      <p><a href="#">Back to top</a></p>
    </div>
    <!-- Bootstrap core JavaScript ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/firebase.js"></script>
    <script type="text/javascript" src="js/blog.js"></script>

    <script type="text/javascript" src="js/pagedown/Markdown.Converter.js"></script>
    <script type="text/javascript" src="js/pagedown/Markdown.Sanitizer.js"></script>
    <script type="text/javascript" src="js/pagedown/Markdown.Editor.js"></script>
    <script type="text/javascript" src="js/prettify.js"></script>       
    <script type="text/javascript" src="js/pagedown/Markdown.Extra.js"></script>
    <script>

      $(function(){
        var tagsLoaded = false,
            originTags = [],
            login = false,
            converter;
        //adding a post
        $("#add_post").click(function (){
            var $this = $(this);
            $this.addClass("disabled");
            loadTags();
            clearForm();
            BLOG.Util.countPosts(function(data){
                if(data >= 0) {
                    $this.removeClass("disabled");
                }
            });
            toggleView();
        });

        function showEditor() {
          if(!converter) {
            converter = Markdown.getSanitizingConverter();
            Markdown.Extra.init(converter, {
              extensions: "all",
              highlighter: "prettify"
            });
            var editor = new Markdown.Editor(converter);
            editor.hooks.chain("onPreviewRefresh", prettyPrint); // google code prettify
            editor.run();
          }
        }

        function clearForm() {
            $("input[name='title']").val("");
            $("input[type='checkbox']").removeAttr("checked");
            $("textarea[name='content']").val("");
            $("#post_id").val("");
        }

        function toggleView() {
            $("#blog_form").toggle();
            $("#blogs_list").toggle();
            $("#blog_editor").toggle();
            showEditor();
        }    

        $("#return_btn").click(function() {
            toggleView();
        });
        //save blog clicked
        $("#post_save").click(function() {
          var title = $("input[name='title']").val() || "";
          var text = $("#wmd-input").val() || "";
          var id = $("#post_id").val() || "";
          var createTime = $("#create_time").val() || "";
          var tags = []; 
          $("input[type='checkbox']:checked").each(function(){ 
              tags.push($(this).val()); 
          }); 

          if (title != "" && text != "" && tags.length > 0) {
            item = {
              title: title,
              createTime: createTime,
              tags: tags,
              key: id
            };
            BLOG.Util.saveBlog(item, text, originTags, function () {
                alert("Save successfully!");
            });
          } else {
            alert("Please input title, tags and content to add!")
          }
          return false;
        });

        //get auth       
        BLOG.Util.getAuth(function(data) {
          afterLogin(data);
        });
        
        function afterLogin(data) {
          if(BLOG.Util.validateAuth(data)) {
             $('#login_form').hide();
             login = true;
             switch2ListView();
          }
        }

        function editBlog() {
            var blogKey = $(this).attr("data-provide"),
                $title = $("input[name='title']");
            toggleView();
            loadTags();
            clearForm();
            BLOG.Util.loadBlog(blogKey, false, function(blog) {
                 $("input[name='title']").val(blog.title);
                 $("#wmd-input").val(blog.text);
                 if(converter) {
                    $("#wmd-preview").html(converter.makeHtml(blog.text));
                 }
                 $("#post_id").val(blogKey);
                 $("#create_time").val(blog.createTime);
                 originTags = blog.tags;
                 $.each(blog.tags,function(n,tag) {
                    $("input[value=" + tag +"]").attr("checked","true");
                 });
            });
        }

        function switch2ListView() {
            BLOG.Util.loadAll(function (blogs) {
                var $table = $("#blogs_list"),
                    $td,
                    $tbody = $table.children("tbody");
                $tbody.empty();
                $.each(blogs, function(n,blog) {
                  $link = $("<a href='index.html?id=" + blog.key + "'>").text(blog.title);
                  $editLink = $("<a href='#' data-provide='" + blog.key + "'>").text("编辑");
                  $editLink.click(editBlog);
                  $td = $("<td>").append($link);
                  $("<tr/>").append($td).append($("<td>").text(blog.tagNames))
                      .append($("<td>").text(blog.createTime)).append($("<td>").append($editLink))
                      .appendTo($tbody);   
               });
            });
        }

        function loadTags() {
          if(!tagsLoaded) {
            BLOG.Util.loadTags(function(tags) {
                $.each(tags,function(n,tag) {
                   if(tag) {
                      $("<label class='checkbox-inline'/>").text(tag.name)
                        .append($("<input type='checkbox'  value='" + n + "'/>")).appendTo($("#blog_tags"));
                   }
                });
                tagsLoaded = true;
            });
          }
        }

        //login button clicked
        $("#login_btn").click(function(e){
           BLOG.Util.login(function(user) {
              afterLogin(user);
           });
           return false;
        });
      });
    </script>
    
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug 
    <script src="js/ie10-viewport-bug-workaround.js"></script>
    -->
  </body>
</html>